unit UFrmTipoDocumento;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, UFrmBase, Data.DB, Vcl.Buttons, TipoDocumentoController,
  Vcl.StdCtrls, Vcl.ComCtrls, Vcl.Grids, Vcl.DBGrids,TipoDOcumento,Generics.Collections,
  bsSkinCtrls, bsSkinGrids, bsDBGrids, Vcl.Mask, bsSkinBoxCtrls,
  BusinessSkinForm,ServerData, bsdbctrls, Vcl.DBCtrls;

type
  TFrmTipoDocumento = class(TFrmBase)
    dbeNome: TbsSkinDBEdit;
    bsSkinStdLabel3: TbsSkinStdLabel;
    bsSkinStdLabel4: TbsSkinStdLabel;
    DBEdit1: TDBEdit;
    procedure FormCreate(Sender: TObject);
    procedure BtnSalvarClick(Sender: TObject);
    procedure BtnExcluirClick(Sender: TObject);
    procedure btnPesquisarClick(Sender: TObject);
    procedure BtnInserirClick(Sender: TObject);
  private
    { Private declarations }
    Controller : TTipoDocumentoController;
    fCamposPesquisa:TObjectList<TServerData>;
    procedure AtualizaGrid(tipos_documentos:TObjectList<TTipoDocumento>);
    procedure AtualizaCamposPesquisa(campos:TObjectList<TServerData>);
  public
    { Public declarations }
  end;

var
  FrmTipoDocumento: TFrmTipoDocumento;

implementation

{$R *.dfm}

uses UDm;



procedure TFrmTipoDocumento.AtualizaGrid(tipos_documentos: TObjectList<TTipoDocumento>);
var
 i :integer;
begin
Dm.cdsTipoDOcumento.EmptyDataSet;
for i := 0 to tipos_documentos.Count - 1 do
  begin
    Dm.cdsTipoDocumento.Append;
    Dm.cdsTipoDocumento.Fields[0].AsInteger := tipos_documentos.Items[i].Id;
    Dm.cdsTipoDocumento.Fields[1].AsString := tipos_documentos.Items[i].Nome;
    Dm.cdsTipoDocumento.Fields[2].AsCurrency := tipos_documentos.Items[i].TamanhoMaximo;
    Dm.cdsTipoDocumento.Post;
  end;
  Dm.cdsTipoDocumento.Open;
  Dm.cdsTipoDocumento.EnableControls;
end;


procedure TFrmTipoDocumento.BtnExcluirClick(Sender: TObject);
begin
  inherited;
  try
    Controller.Exclui(Dm.cdsTipoDOcumentoID.Value);
    Dm.cdsTipoDOcumento.Delete;
  except
      ShowMessage('Erro ao tentar excluir o tipo de documento');
  end;
end;

procedure TFrmTipoDocumento.BtnInserirClick(Sender: TObject);
begin
  inherited;
  self.dbeNome.SetFocus;
end;

procedure TFrmTipoDocumento.btnPesquisarClick(Sender: TObject);
begin
  inherited;
  Dm.cdsTipoDOcumento.EmptyDataSet;
  AtualizaGrid(Controller.Consulta(self.fCamposPesquisa[self.cbbPesquisa.ItemIndex].Key,ePesquisa.Text,'like',0));
end;

procedure TFrmTipoDocumento.BtnSalvarClick(Sender: TObject);
var
tipoDocumento:TTipoDocumento;
list:TObjectList<TTipoDocumento>;
begin
  //inherited;
  tipoDocumento:=TTipoDocumento.Create;
  try
    tipoDocumento.Id := Dm.cdsTipoDOcumentoID.Value;
    tipoDocumento.Nome := Dm.cdsTipoDOcumentoNOME.Value;
    tipoDocumento.TamanhoMaximo := Dm.cdsTipoDOcumentoTAMANHO_MAXIMO.Value;
    try
      if Dm.cdsTipoDocumento.State in [dsInsert] then
          Dm.cdsTipoDocumentoID.Value := TTipoDocumento(Controller.Insere(tipoDocumento)).id
      else  Dm.cdsTipoDocumentoID.Value := TTipoDocumento(Controller.Altera(tipoDocumento)).Id;
    Dm.cdsTipoDOcumento.Post;
    self.PCBase.TabIndex := 0;
    except
      ShowMessage('Erro ao tentar salvar o tipo de documento');
    end;
  finally
    tipoDocumento.Free
  end;

end;

procedure TFrmTipoDocumento.FormCreate(Sender: TObject);
var
key:String;
begin
  inherited;
  Controller := TTipoDocumentoController.Create;
  fCamposPesquisa := Controller.IndexFields;
  AtualizaCamposPesquisa(fCamposPesquisa);
  AtualizaGrid(Controller.Consulta('1','1','ALL',0));
  Dm.cdsTipoDOcumento.Fields[2].Visible := false;
end;

procedure TFrmTipoDocumento.AtualizaCamposPesquisa(
  campos: TObjectList<TServerData>);
var
 i,index :integer;
begin
cbbPesquisa.Items.Clear;
for i := 0 to campos.Count - 1 do
  begin
    if campos[i].DefaultIndex then
        index := i;
    cbbPesquisa.Items.Add(campos[i].Value);
  end;
  cbbPesquisa.ItemIndex := index;
end;

end.
